{% extends "base.html" %}

{% block title %}{{ 'Editar' if quote else 'Nova' }} Cotação{% endblock %}
{% block header_title %}{{ 'Editar' if quote else 'Nova' }} Cotação{% endblock %}

{% block content %}
<div class="max-w-4xl">
    <div class="bg-white rounded-xl shadow-sm p-6">
        <form method="POST" enctype="multipart/form-data">
            <!-- Client Section -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    Dados do Cliente
                </h3>
                <div class="bg-sand/30 rounded-lg p-4">
                    <div class="mb-4">
                        <label class="flex items-center gap-2 mb-3">
                            <input type="checkbox" id="use_registered_client" class="rounded text-primary" 
                                {{ 'checked' if quote and quote.client_id else '' }}
                                onchange="toggleClientType()">
                            <span class="text-sm font-medium text-gray-700">Cliente cadastrado</span>
                        </label>
                    </div>
                    
                    <!-- Registered Client -->
                    <div id="registered_client_fields" class="{{ '' if quote and quote.client_id else 'hidden' }}">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Selecione o Cliente</label>
                            <select name="client_id" id="client_id" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary">
                                <option value="">Selecione um cliente</option>
                                {% for client in clients %}
                                <option value="{{ client.id }}" {{ 'selected' if quote and quote.client_id == client.id else '' }}>
                                    {{ client.name }} {% if client.phone %}({{ client.phone }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Lead Fields -->
                    <div id="lead_fields" class="{{ 'hidden' if quote and quote.client_id else '' }}">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Cliente *</label>
                                <input type="text" name="lead_name" value="{{ quote.lead_name if quote else '' }}"
                                    class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary"
                                    placeholder="Nome completo">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" name="lead_email" value="{{ quote.lead_email if quote else '' }}"
                                    class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary"
                                    placeholder="email@exemplo.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Telefone *</label>
                                <input type="text" name="lead_phone" value="{{ quote.lead_phone if quote else '' }}"
                                    class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary"
                                    placeholder="(11) 99999-9999">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Product Details -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                    </svg>
                    Detalhes do Pedido
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Modelo</label>
                        <select name="model" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary">
                            <option value="Camiseta" {{ 'selected' if quote and quote.model == 'Camiseta' else '' }}>Camiseta</option>
                            <option value="Regata" {{ 'selected' if quote and quote.model == 'Regata' else '' }}>Regata</option>
                            <option value="Baby Look" {{ 'selected' if quote and quote.model == 'Baby Look' else '' }}>Baby Look</option>
                            <option value="Polo" {{ 'selected' if quote and quote.model == 'Polo' else '' }}>Polo</option>
                            <option value="Moletom" {{ 'selected' if quote and quote.model == 'Moletom' else '' }}>Moletom</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cor da Camiseta</label>
                        <input type="text" name="shirt_color" value="{{ quote.shirt_color if quote else '' }}"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary"
                            placeholder="Ex: Preta, Branca, Cinza">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quantidade Total *</label>
                        <input type="number" name="total_quantity" value="{{ quote.total_quantity if quote else 10 }}" min="1"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary"
                            onchange="calculateTotal()">
                    </div>
                </div>
            </div>
            
            <!-- Print Details -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Detalhes da Estampa
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Posição da Estampa</label>
                        <select name="print_position" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary">
                            <option value="Só Frente" {{ 'selected' if quote and quote.print_position == 'Só Frente' else '' }}>Só Frente</option>
                            <option value="Só Costas" {{ 'selected' if quote and quote.print_position == 'Só Costas' else '' }}>Só Costas</option>
                            <option value="Frente e Costas" {{ 'selected' if quote and quote.print_position == 'Frente e Costas' else '' }}>Frente e Costas</option>
                            <option value="Manga" {{ 'selected' if quote and quote.print_position == 'Manga' else '' }}>Manga</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tamanho da Estampa</label>
                        <input type="text" name="print_size" value="{{ quote.print_size if quote else '' }}"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary"
                            placeholder="Ex: 7cm x 7cm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cor da Estampa</label>
                        <input type="text" name="print_color" value="{{ quote.print_color if quote else '' }}"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary"
                            placeholder="Ex: Branco, Preto">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Estampa Cadastrada</label>
                        <select name="print_id" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary">
                            <option value="">Personalizada</option>
                            {% for print in prints %}
                            <option value="{{ print.id }}" {{ 'selected' if quote and quote.print_id == print.id else '' }}>{{ print.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Pricing -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Valores
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Preço Unitário (R$)</label>
                        <input type="number" name="unit_price" id="unit_price" step="0.01" 
                            value="{{ quote.unit_price if quote and quote.unit_price else '' }}"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary"
                            placeholder="0.00" onchange="calculateTotal()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Valor Total (R$) *</label>
                        <input type="number" name="total_price" id="total_price" step="0.01" 
                            value="{{ quote.total_price if quote and quote.total_price else '' }}"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary"
                            placeholder="0.00" onchange="calculateDownPayment()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sinal (%)</label>
                        <input type="number" name="down_payment_percent" id="down_payment_percent" 
                            value="{{ quote.down_payment_percent if quote else 40 }}" min="0" max="100"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary"
                            onchange="calculateDownPayment()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Valor do Sinal (R$)</label>
                        <input type="number" name="down_payment_value" id="down_payment_value" step="0.01" 
                            value="{{ quote.down_payment_value if quote and quote.down_payment_value else '' }}"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-gray-50" readonly>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">PIX para Pagamento</label>
                    <input type="text" name="pix_key" value="{{ quote.pix_key if quote else '11998896725' }}"
                        class="w-full md:w-1/2 px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary">
                </div>
            </div>
            
            <!-- Delivery -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                    </svg>
                    Entrega
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Método de Entrega</label>
                        <select name="delivery_method" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary">
                            <option value="delivery" {{ 'selected' if quote and quote.delivery_method == 'delivery' else '' }}>Entrega</option>
                            <option value="pickup" {{ 'selected' if quote and quote.delivery_method == 'pickup' else '' }}>Retirada</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Prazo (dias)</label>
                        <input type="number" name="delivery_days" value="{{ quote.delivery_days if quote else 15 }}" min="1"
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fornecedor</label>
                        <select name="supplier_id" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary">
                            <option value="">Selecione um fornecedor</option>
                            {% for supplier in suppliers %}
                            <option value="{{ supplier.id }}" {{ 'selected' if quote and quote.supplier_id == supplier.id else '' }}>
                                {{ supplier.name }} ({{ supplier.production_time_days }} dias)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            
            {% if quote %}
            <!-- Status -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Status</h3>
                <select name="status" class="w-full md:w-1/3 px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    <option value="draft" {{ 'selected' if quote.status == 'draft' else '' }}>Rascunho</option>
                    <option value="pending" {{ 'selected' if quote.status == 'pending' else '' }}>Pendente</option>
                    <option value="sent" {{ 'selected' if quote.status == 'sent' else '' }}>Enviada</option>
                    <option value="approved" {{ 'selected' if quote.status == 'approved' else '' }}>Aprovada</option>
                    <option value="rejected" {{ 'selected' if quote.status == 'rejected' else '' }}>Rejeitada</option>
                    <option value="converted" {{ 'selected' if quote.status == 'converted' else '' }}>Convertida em Pedido</option>
                </select>
            </div>
            {% endif %}
            
            <!-- Reference Image/URL -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Imagem de Referência
                </h3>
                <div class="bg-sand/30 rounded-lg p-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Upload de Imagem</label>
                            <input type="file" name="quote_image" accept="image/*"
                                class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white">
                            <p class="text-xs text-gray-500 mt-1">Formatos: PNG, JPG, JPEG, GIF, WEBP (máx. 5MB)</p>
                            {% if quote and quote.image_path %}
                            <div class="mt-3 p-3 bg-white rounded-lg border border-gray-200">
                                <p class="text-sm text-gray-600 mb-2">Imagem atual:</p>
                                <img src="{{ url_for('static', filename=quote.image_path) }}" alt="Imagem de referência" class="max-h-32 rounded">
                                <label class="flex items-center gap-2 mt-2 text-sm text-red-600 cursor-pointer">
                                    <input type="checkbox" name="delete_image" value="1" class="rounded text-red-600">
                                    Remover imagem
                                </label>
                            </div>
                            {% endif %}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ou Link de Referência (URL)</label>
                            <input type="url" name="reference_url" value="{{ quote.reference_url if quote else '' }}"
                                class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary"
                                placeholder="https://exemplo.com/imagem.jpg">
                            <p class="text-xs text-gray-500 mt-1">Cole o link de uma imagem ou página de referência</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Notes -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                <textarea name="notes" rows="3"
                    class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary"
                    placeholder="Informações adicionais sobre o pedido...">{{ quote.notes if quote else '' }}</textarea>
            </div>
            
            <div class="flex gap-3">
                <button type="submit" class="bg-primary text-white px-6 py-2 rounded-lg font-medium hover:bg-primary/90 transition-colors">
                    {{ 'Atualizar' if quote else 'Criar' }} Cotação
                </button>
                <a href="{{ url_for('quotes') }}" class="px-6 py-2 rounded-lg font-medium border border-gray-200 hover:bg-gray-50 transition-colors">
                    Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

<script>
function toggleClientType() {
    const useRegistered = document.getElementById('use_registered_client').checked;
    document.getElementById('registered_client_fields').classList.toggle('hidden', !useRegistered);
    document.getElementById('lead_fields').classList.toggle('hidden', useRegistered);
    
    if (!useRegistered) {
        document.getElementById('client_id').value = '';
    }
}

function calculateTotal() {
    const qty = parseFloat(document.querySelector('[name="total_quantity"]').value) || 0;
    const unitPrice = parseFloat(document.getElementById('unit_price').value) || 0;
    
    if (qty > 0 && unitPrice > 0) {
        document.getElementById('total_price').value = (qty * unitPrice).toFixed(2);
        calculateDownPayment();
    }
}

function calculateDownPayment() {
    const total = parseFloat(document.getElementById('total_price').value) || 0;
    const percent = parseFloat(document.getElementById('down_payment_percent').value) || 40;
    
    document.getElementById('down_payment_value').value = (total * percent / 100).toFixed(2);
}
</script>
{% endblock %}
